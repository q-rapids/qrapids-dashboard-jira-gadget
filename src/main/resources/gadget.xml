<?xml version="1.0" encoding="UTF-8" ?>
<Module>

    <!-- Especifiaciones del Gadget (nombre, autor, ) -->
    <!-- screenshot: direccion de la imagen que un container o directory pueden usar para ilustrar el gadget -->
    <!-- thumbnail: direccion de la imagen en miniatura (120x60 px) que un container o directory pueden usar para ilustrar el gadget-->

    <ModulePrefs title="__MSG_gadget.title__"
                 directory_title="__MSG_gadget.title__"
                 description="__MSG_gadget.description__"
                 author="Surname Name"
                 author_email="author@email.com"
                 screenshot="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/qrapids_logo.png"
                 thumbnail="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/qrapids_logo.png">

        <!-- El elemento indica al container que el gadget puede utilizar una función específica -->
        <Optional feature="gadget-directory">
            <!-- Permite suministrar parametros para las funciones solicitadas a traves de los elementos -->
            <Param name="categories">
                JIRA
                Charts
                QRapids
            </Param>
        </Optional>
        <Optional feature="atlassian.util" />
        <Optional feature="auth-refresh" />

        <!-- El elemento indica al container que el gadget necesita un caracteristica especifica (librerias) -->
        <Require feature="views" />
        <Require feature="settitle"/>
        <Require feature="oauthpopup" />
        <Require feature="opensocial-0.8" />
        <Require feature="dynamic-height"/>

        #oauth
        <Locale messages="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/i18n/ALL_ALL.xml"/>
    </ModulePrefs>

    <!--
    Esta sección le permite a los usuarios una forma de proporcionar sus preferencias "preferencias del usuario".
    Estos campos de entrada del usuario se convierten en controles de interfaz de usuario cuando se ejecuta el gadget.
    Cuando se muestra el gadget en iGoogle, se puede acceder a las preferencias del usuario desde el menú desplegable "Editar".

    El contenedor maneja la generación de la IU de configuración, guarda la configuración y proporciona una API para acceder a la configuración en JavaScript.
    -->
    <UserPref name="show_date" display_name="Show Dates?" datatype="bool" default_value="true"/>
    <UserPref name="show_summ" display_name="Show Summaries?" datatype="bool" default_value="true"/>
    <UserPref name="num_entries" display_name="Number of Entries:" default_value="5"/>
    <UserPref name="selectedTab" datatype="hidden"/>

    <!--
    En esta sección, definirá el tipo de contenido, e incluirá el contenido en sí mismo o proporcionará una URL para extraer el contenido de una fuente externa.
    Combinará los atributos y las preferencias del usuario y la información.

    Hay dos tipos principales de contenido de gadget, que se distinguen por el atributo type del elemento <Content>.

    - URL: incluyen contenido de un sitio remoto, pero no tienen acceso completo a las características del contenedor.
           Este tipo de gadget es compatible con la compatibilidad con los gadgets de iGoogle heredados existentes,
           pero se considera obsoleto y debe evitarse al crear nuevos gadgets.

    - HTML: incluyen el contenido directamente dentro del elemento <Content>. Esto incluye el codigo HTML, CSS y JavaScript que el contenedor representará en el iframe del gadget.
     Este contenido debe incluirse en una sección CDATA para evitar que el analizador de especificaciones del gadget interprete el marcado HTML incrustado como XML.

    Los gadgets pueden definir múltiples secciones de contenido, cada una con una vista diferente.
    Las vistas admitidas por los contenedores de Atlassian son predeterminadas para la vista estándar de un gadget en una página junto con otros gadgets y contenido,
    y canvas para la vista maximizada de un solo gadget en una página por sí solo. Otros contenedores pueden admitir tipos de vista adicionales.
    Si la misma sección de contenido debe mostrarse en más de una vista, puede especificar varias vistas, separadas por comas.

    href="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/html/jira-gadget-qrapids-plugin.html"
    -->

    <Content type="html" view="canvas,profile" >
        <![CDATA[

            <head>
                #requireResource("com.atlassian.jira.gadgets:common")
                #requireResource("com.atlassian.gadgets.publisher:ajs-gadgets")
                #requireResource("com.atlassian.plugins.qrapids:jira-gadget-qrapids-plugin")
                #requireResource("confluence.web.resources:jquery")
                #requireResource("confluence.web.resources:ajs")
                #requireResource("com.atlassian.auiplugin:ajs")
                #includeResources()


                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
                <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.js"></script>
                <script src="https://d3js.org/d3.v5.js"></script>

                <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
                <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>


                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/gaugeChart.js" type="text/javascript"></script>
                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/jira-gadget-qrapids-plugin.js" type="text/javascript"></script>
                <link href="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/css/jira-gadget-qrapids-plugin.css" type="text/css" rel="stylesheet">

                <script type="text/javascript">

                    AJS.$(document).ready(function () {

                        // Tabs
                        // Strategic Indicators

                        AJS.$('#id_tab_si').on('click', function(){
                            AJS.$("#myTopnav .tab-nav").removeClass('active')
                            AJS.$('#id_tab_si').addClass('active');
                            if (AJS.$('#id_graphical_menu_item').hasClass('background-active-view'))
                                getDataStrategicIndicators();
                            else
                                printCurrentTableSI();
                        });

                        // Detailed Strategic Indicators

                        AJS.$('#id_tab_dsi').on('click', function(){
                            AJS.$("#myTopnav .tab-nav").removeClass('active')
                            AJS.$('#id_tab_dsi').addClass('active');
                            getDataDetailedStrategicIndicators();
                            if (AJS.$('#id_graphical_menu_item').hasClass('background-active-view'))
                                printCurrentChartDSI();
                            else
                                printCurrentTableDSI();
                        });

                        // Quality Factors
                        AJS.$('#id_tab_qf').on('click', function(){
                            AJS.$("#myTopnav .tab-nav").removeClass('active')
                            AJS.$('#id_tab_qf').addClass('active');
                            getDataQualityFactors();
                            if (AJS.$('#id_graphical_menu_item').hasClass('background-active-view'))
                                printCurrentChartQF();
                            else
                                printCurrentTableQF();
                        });

                        // Metrics
                        AJS.$('#id_tab_m').on('click', function(){
                            AJS.$("#myTopnav .tab-nav").removeClass('active')
                            AJS.$('#id_tab_m').addClass('active');
                        });

                        // Menus Items Dropdown

                        AJS.$('#id_graphical_menu_item').on('click', function(){
                            AJS.$("#id_table_menu_item").removeClass('background-active-view')
                            AJS.$('#id_graphical_menu_item').addClass('background-active-view');
                            printCurrentChartSI();
                        });

                        AJS.$('#id_table_menu_item').on('click', function(){
                            AJS.$("#id_graphical_menu_item").removeClass('background-active-view')
                            AJS.$('#id_table_menu_item').addClass('background-active-view');
                            printCurrentTableSI();
                        });

                        AJS.$('#id_radar_menu_item').on('click', function(){

                        });

                        AJS.$('#id_histo_menu_item').on('click', function(){

                        });

                        //GET AND SAVE DATA
                        getDataStrategicIndicators();
                    });


                    function getDataStrategicIndicators(){
                        var gadget_strategic_indicators = AJS.Gadget({
                            baseUrl: "__ATLASSIAN_BASE_URL__",
                            useOauth: "/rest/gadget/1.0/currentUser",
                            view: {
                                template: function(args) {
                                    var gadget = this;
                                    var data = args.dtoSIE;
                                    console.log("**********************gadget.getStrategicIndicators()***************************");
                                    console.log(data);
                                    printCurrentChartSI(data);
                                },
                                args: [{
                                    key: "dtoSIE",
                                    ajaxOptions: function() {
                                        return {
                                            url: "/rest/qrapids-gadget/1.0/StrategicIndicators/CurrentEvaluation.json"
                                        };
                                    }
                                }]
                            }
                        });
                    }

                    function getDataDetailedStrategicIndicators(){
                        var gadget_strategic_indicators = AJS.Gadget({
                            baseUrl: "__ATLASSIAN_BASE_URL__",
                            useOauth: "/rest/gadget/1.0/currentUser",
                            view: {
                                template: function(args) {
                                    var gadget = this;
                                    var data = args.dtoDSIE;
                                    console.log("**********************1gadget.getDataDetailedStrategicIndicators()***************************");
                                    console.log(data);
                                    saveDataDetailedStrategicIndicators(data);
                                },
                                args: [{
                                    key: "dtoDSIE",
                                    ajaxOptions: function() {
                                        return {
                                            url: "/rest/qrapids-gadget/1.0/DetailedStrategicIndicators/CurrentEvaluation.json"
                                        };
                                    }
                                }]
                            }
                        });
                    }

                    function getDataQualityFactors(){
                        var gadget_strategic_indicators = AJS.Gadget({
                            baseUrl: "__ATLASSIAN_BASE_URL__",
                            useOauth: "/rest/gadget/1.0/currentUser",
                            view: {
                                template: function(args) {
                                    var gadget = this;
                                    var data = args.dtoQF;
                                    console.log("**********************gadget.getDataQualityFactors()***************************");
                                    console.log(data);
                                    saveDataQualityFactors(data);
                                },
                                args: [{
                                    key: "dtoQF",
                                    ajaxOptions: function() {
                                        return {
                                            url: "/rest/qrapids-gadget/1.0/QualityFactors/CurrentEvaluation.json"
                                        };
                                    }
                                }]
                            }
                        });
                    }

                    function getMessage(){
                        var gadget_message = AJS.Gadget({

                            baseUrl: "__ATLASSIAN_BASE_URL__",
                            useOauth: "/rest/gadget/1.0/currentUser",
                            view: {
                                template: function(args) {
                                    var gadget = this;

                                    var messageResponse = args;

                                    console.log("**********************MESSAGE***************************");
                                    console.log(args.value);

                                    var html = "";
                                    html += "<p>" + args.value + "</p>";
                                    document.getElementById('dsi').innerHTML = html;

                                    //gadget.getView().html(messageResponse);
                                },
                                args: [{
                                    key: "value",
                                    ajaxOptions: function() {
                                        return {
                                            url: "/rest/qrapids-gadget/1.0/message.json"
                                        };
                                    }
                                }]
                            }
                        });
                    }

                    function getProjectData(){
                        var projects = AJS.Gadget({

                            baseUrl: "__ATLASSIAN_BASE_URL__",
                            useOauth: "/rest/gadget/1.0/currentUser",
                            view: {
                                template: function(args) {
                                    var gadget = this;

                                    var projectList = AJS.$("<ul/>");

                                    AJS.$(args.projectData.projects).each(function() {
                                        projectList.append(
                                            AJS.$("<li/>").append(
                                                AJS.$("<a/>").attr({
                                                    target: "_parent",
                                                    title: gadgets.util.escapeString(this.key),
                                                    href: "__ATLASSIAN_BASE_URL__" + "/browse/" + this.key
                                                }).text(this.name)
                                            )
                                        );
                                    });

                                    //gadget.getView().html(projectList);

                                    document.getElementById('m').innerHTML = projectList.text();

                                    console.log("*********************PROJECTS****************************");
                                    console.log(args.projectData);

                                },
                                args: [{
                                    key: "projectData",
                                    ajaxOptions: function() {
                                        return {
                                            url: "/rest/qrapids-gadget/1.0/projects.json"
                                        };
                                    }
                                }]
                            }
                        });
                    }
                </script>
            </head>

            <body>
                <div class="topnav" id="myTopnav">
                    <a id="id_tab_si" class="tab-nav active" data-toggle="tab" href="#si">Strategic Indicators</a>
                    <a id="id_tab_dsi" class="tab-nav" data-toggle="tab" href="#dsi">Detailed Strategic Indicators</a>
                    <a id="id_tab_qf" class="tab-nav" data-toggle="tab" href="#qf">Quality Factors</a>
                    <a id="id_tab_m" class="tab-nav" data-toggle="tab" href="#m">Metrics</a>
                    <span class="span-position">
                        <div class="dropdown">
                            <a href="#" data-toggle="dropdown" class="dropdown-toggle">View mode <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a id="id_graphical_menu_item" class="background-active-view">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/graphical.png" alt="graphical data"> Graphical
                                    </a>
                                </li>
                                <li>
                                    <a id="id_table_menu_item">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/table.png" alt="table data"> Table
                                    </a>
                                </li>
                                <li role="separator" class="divider"></li>
                                <li>
                                    <a id="id_radar_menu_item" class="background-active-view">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/radar.png" alt="radar data"> Radar
                                    </a>
                                </li>
                                <li>
                                    <a id="id_histo_menu_item">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/histo.png" alt="histo data"> Histo
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </span>
                </div>

                <div class="tab-content clearfix">
                    <div class="tab-pane active" id="si"></div>
                    <div class="tab-pane" id="dsi"></div>
                    <div class="tab-pane" id="qf"></div>
                    <div class="tab-pane" id="m">
                        <h3>Metrics</h3>
                    </div>
                </div>

                <div id="debug_div" style="font-size:9pt; padding:5px; color: red;"></div>

            </body>


        ]]>
    </Content>
</Module>