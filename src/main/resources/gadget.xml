<?xml version="1.0" encoding="UTF-8" ?>
<Module>

    <!-- Especifiaciones del Gadget (nombre, autor, ) -->
    <!-- screenshot: direccion de la imagen que un container o directory pueden usar para ilustrar el gadget -->
    <!-- thumbnail: direccion de la imagen en miniatura (120x60 px) que un container o directory pueden usar para ilustrar el gadget-->

    <ModulePrefs title="__MSG_gadget.title__"
                 directory_title="__MSG_gadget.title__"
                 description="__MSG_gadget.description__"
                 author="Surname Name"
                 author_email="author@email.com"
                 screenshot="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/qrapids_logo.png"
                 thumbnail="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/qrapids_logo.png">

        <!-- El elemento indica al container que el gadget puede utilizar una función específica -->
        <Optional feature="gadget-directory">
            <!-- Permite suministrar parametros para las funciones solicitadas a traves de los elementos -->
            <Param name="categories">
                JIRA
                Charts
                QRapids
            </Param>
        </Optional>
        <Optional feature="atlassian.util" />
        <Optional feature="auth-refresh" />

        <!-- El elemento indica al container que el gadget necesita un caracteristica especifica (librerias) -->
        <Require feature="views" />
        <Require feature="settitle"/>
        <Require feature="oauthpopup" />
        <Require feature="opensocial-0.8" />
        <Require feature="dynamic-height"/>
        <Require feature="minimessage"/>
        <Require feature="setprefs" />

        #oauth
        <Locale messages="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/i18n/ALL_ALL.xml"/>
    </ModulePrefs>

    <!--
    Esta sección le permite a los usuarios una forma de proporcionar sus preferencias "preferencias del usuario".
    Estos campos de entrada del usuario se convierten en controles de interfaz de usuario cuando se ejecuta el gadget.
    Cuando se muestra el gadget en iGoogle, se puede acceder a las preferencias del usuario desde el menú desplegable "Editar".

    El contenedor maneja la generación de la IU de configuración, guarda la configuración y proporciona una API para acceder a la configuración en JavaScript.
    -->
    <UserPref name="show_date" display_name="Show Dates?" datatype="bool" default_value="true"/>
    <UserPref name="show_summ" display_name="Show Summaries?" datatype="bool" default_value="true"/>
    <UserPref name="num_entries" display_name="Number of Entries:" default_value="5"/>
    <UserPref name="selectedTab" datatype="hidden"/>


    <!--
    En esta sección, definirá el tipo de contenido, e incluirá el contenido en sí mismo o proporcionará una URL para extraer el contenido de una fuente externa.
    Combinará los atributos y las preferencias del usuario y la información.

    Hay dos tipos principales de contenido de gadget, que se distinguen por el atributo type del elemento <Content>.

    - URL: incluyen contenido de un sitio remoto, pero no tienen acceso completo a las características del contenedor.
           Este tipo de gadget es compatible con la compatibilidad con los gadgets de iGoogle heredados existentes,
           pero se considera obsoleto y debe evitarse al crear nuevos gadgets.

    - HTML: incluyen el contenido directamente dentro del elemento <Content>. Esto incluye el codigo HTML, CSS y JavaScript que el contenedor representará en el iframe del gadget.
     Este contenido debe incluirse en una sección CDATA para evitar que el analizador de especificaciones del gadget interprete el marcado HTML incrustado como XML.

    Los gadgets pueden definir múltiples secciones de contenido, cada una con una vista diferente.
    Las vistas admitidas por los contenedores de Atlassian son predeterminadas para la vista estándar de un gadget en una página junto con otros gadgets y contenido,
    y canvas para la vista maximizada de un solo gadget en una página por sí solo. Otros contenedores pueden admitir tipos de vista adicionales.
    Si la misma sección de contenido debe mostrarse en más de una vista, puede especificar varias vistas, separadas por comas.

    href="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/html/jira-gadget-qrapids-plugin.html"
    -->

    <Content type="html" view="canvas,profile" >
        <![CDATA[

            <head>
                #requireResource("com.atlassian.jira.gadgets:common")
                #requireResource("com.atlassian.gadgets.publisher:ajs-gadgets")
                #requireResource("com.atlassian.plugins.qrapids:jira-gadget-qrapids-plugin")
                #requireResource("confluence.web.resources:jquery")
                #requireResource("confluence.web.resources:ajs")
                #requireResource("com.atlassian.auiplugin:ajs")
                #supportedLocales("gadget.common")
                #includeResources()


                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
                <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.js"></script>
                <script src="https://d3js.org/d3.v5.js"></script>

                <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
                <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>


                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/gaugeChart.js" type="text/javascript"></script>
                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/radarChart.js" type="text/javascript"></script>
                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/lineChart.js" type="text/javascript"></script>
                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/stackedLineChart.js" type="text/javascript"></script>
                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/scriptDatePicker.js" type="text/javascript"></script>
                <script src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/js/jira-gadget-qrapids-plugin.js" type="text/javascript"></script>
                <link href="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/css/jira-gadget-qrapids-plugin.css" type="text/css" rel="stylesheet">

                <script type="text/javascript">
                    (function() {
                        var dataCurrentSI = [];
                        var dataHistoricalSI  = [];

                        var dataCurrentDSI  = [];
                        var dataHistoricalDSI  = [];

                        var dataCurrentQF  = [];
                        var dataHistoricalQF  = [];

                        var dataCurrentM  = [];
                        var dataHistoricalM  = [];

                        var from = '2015-01-01';
                        var to = getToday();

                        var gadgetQRAPID = AJS.Gadget({
                            baseUrl: "__ATLASSIAN_BASE_URL__",
                            useOauth: "/rest/gadget/1.0/currentUser",
                            config: {
                               descriptor: function(args) {
                                  //document.getElementById('chart').style.visibility = "hidden";
                                  var gadget = this;
                                  return {
                                     action: "/rest/gadget/1.0/currentUser",
                                     theme : function () {
                                        if (gadgets.window.getViewportDimensions().width < 450) {
                                           return "gdt top-label";
                                        } else {
                                           return "gdt";
                                        }
                                     }(),
                                     fields: [
                                        {
                                           userpref: "gadgetURLUserPref",
                                           label: "URL:",
                                           description: "Enter the URL to use on the Gadget.",
                                           type: "text",
                                           value: gadget.getPref("gadgetURLUserPref")
                                        },
                                        {
                                           userpref: "barExampleSelectUserPref",
                                           label: "Example select:",
                                           description: "Example.",
                                           type: "select",
                                           selected: gadget.getPref("barExampleSelectUserPref"),
                                           options:[
                                              {
                                                 label: "Bar",
                                                 value: "bar"
                                              },
                                              {
                                                 label: "Doughnut",
                                                 value: "doughnut"
                                              },
                                              {
                                                 label: "Horizontal Bar",
                                                 value: "horizontalBar"
                                              },
                                              {
                                                 label: "Line",
                                                 value: "line"
                                              },
                                              {
                                                 label: "Pie",
                                                 value: "pie"
                                              },
                                              {
                                                 label: "Stacked",
                                                 value: "stacked"
                                              }
                                           ]
                                        },
                                        {
                                            type: "checkbox",
                                            label: "Example checkbox:",
                                            options: [{id: 1, value: "true", label: " Show changeset info as part of last build details"}],
                                            userpref: "barExampleSelectUserPref",
                                            value: gadget.getPref("barExampleSelectUserPref")
                                        },

                                        AJS.gadget.fields.nowConfigured()
                                     ]
                                  };
                               },
                               args: []
                            },
                            view: {
                                enableReload: false,
                                onResizeReload: true,
                                onResizeAdjustHeight: true,
                                template: function(args) {

                                    console.log(" \\\\\\\\\\\\\\ args ///////////// ");
                                    console.log(args);

                                    var gadget = this;

                                    var apiURL = gadget.getPref("gadgetURLUserPref");
                                    var selectPref = gadget.getPref("barExampleSelectUserPref");
                                    var checkboxExample = gadget.getPref("barExampleSelectUserPref");
                                    console.log(apiURL);
                                    console.log(selectPref);
                                    console.log(checkboxExample);

                                    $("#myTopnav").removeClass('hidden');
                                    $("#myTabContent").removeClass('hidden');

                                    var dataCurrentSI = args.dtoCSI;
                                    var dataHistoricalSI  = args.dtoHSI;

                                    var dataCurrentDSI  = args.dtoCDSI;
                                    var dataHistoricalDSI  = args.dtoHDSI;

                                    var dataCurrentQF  = args.dtoCQF;
                                    var dataHistoricalQF  = args.dtoHQF;

                                    var dataCurrentM;
                                    var dataHistoricalM  = args.dtoHM;

                                    printCurrentChartSI(dataCurrentSI);

                                    // Tabs
                                    $('#id_tab_si').on('click', function(){
                                        $("#myTopnav .tab-nav").removeClass('active');
                                        $('#id_tab_si').addClass('active');

                                        if ($('#id_graphical_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentChartSI(dataCurrentSI);
                                        else if ($('#id_graphical_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalChartSI(dataHistoricalSI);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentTableSI(dataCurrentSI);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalTableSI(dataHistoricalSI);
                                    });

                                    $('#id_tab_dsi').on('click', function(){
                                        $("#myTopnav .tab-nav").removeClass('active');
                                        $('#id_tab_dsi').addClass('active');

                                        if ($('#id_graphical_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentChartDSI(dataCurrentDSI);
                                        else if ($('#id_graphical_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalChartDSI(dataHistoricalDSI);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentTableDSI(dataCurrentDSI);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalTableDSI(dataHistoricalDSI);
                                    });

                                    $('#id_tab_qf').on('click', function(){
                                        $("#myTopnav .tab-nav").removeClass('active');
                                        $('#id_tab_qf').addClass('active');

                                        if ($('#id_graphical_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentChartQF(dataCurrentQF);
                                        else if ($('#id_graphical_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalChartQF(dataHistoricalQF);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentTableQF(dataCurrentQF);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalTableQF(dataHistoricalQF);
                                    });

                                    $('#id_tab_m').on('click', function(){
                                        $("#myTopnav .tab-nav").removeClass('active');
                                        $('#id_tab_m').addClass('active');

                                        if ($('#id_graphical_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentChartM(dataCurrentM);
                                        else if ($('#id_graphical_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalChartM(dataHistoricalM);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_radar_menu_item').hasClass('active')) printCurrentTableM(dataCurrentM);
                                        else if ($('#id_table_menu_item').hasClass('active') && $('#id_historical_menu_item').hasClass('active')) printHistoricalTableM(dataHistoricalM);
                                    });

                                    // Menus Items Dropdown

                                    // G
                                    $('#id_graphical_menu_item').on('click', function(){
                                        $("#id_table_menu_item").removeClass('active');
                                        $('#id_graphical_menu_item').addClass('active');

                                        // -> R
                                        if ($('#id_radar_menu_item').hasClass('active')) {
                                            console.log(" ________________________ G -> R ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printCurrentChartSI(dataCurrentSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printCurrentChartDSI(dataCurrentDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printCurrentChartQF(dataCurrentQF);
                                            else if ($('#id_tab_m').hasClass('active')) printCurrentChartM(dataCurrentM);
                                        }
                                        // -> H
                                        else {
                                            console.log(" ________________________ G -> H ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printHistoricalChartSI(dataHistoricalSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printHistoricalChartDSI(dataHistoricalDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printHistoricalChartQF(dataHistoricalQF);
                                            else if ($('#id_tab_m').hasClass('active')) printHistoricalChartM(dataHistoricalM);
                                        }
                                    });

                                    // T
                                    $('#id_table_menu_item').on('click', function(){
                                        $("#id_graphical_menu_item").removeClass('active');
                                        $('#id_table_menu_item').addClass('active');

                                        // -> R
                                        if ($('#id_radar_menu_item').hasClass('active')) {
                                            console.log(" ________________________ T -> R ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printCurrentTableSI(dataCurrentSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printCurrentTableDSI(dataCurrentDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printCurrentTableQF(dataCurrentQF);
                                            else if ($('#id_tab_m').hasClass('active')) printCurrentTableM(dataCurrentM);
                                        }

                                        // -> H
                                        else {
                                            console.log(" ________________________ T -> H ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printHistoricalTableSI(dataHistoricalSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printHistoricalTableDSI(dataHistoricalDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printHistoricalTableQF(dataHistoricalQF);
                                            else if ($('#id_tab_m').hasClass('active')) printHistoricalTableM(dataHistoricalM);
                                        }
                                    });

                                    // R
                                    $('#id_radar_menu_item').on('click', function(){
                                        $("#id_historical_menu_item").removeClass('active');
                                        $('#id_radar_menu_item').addClass('active');

                                        // G
                                        if ($('#id_graphical_menu_item').hasClass('active')) {
                                            console.log(" ________________________ G <- R ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printCurrentChartSI(dataCurrentSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printCurrentChartDSI(dataCurrentDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printCurrentChartQF(dataCurrentQF);
                                            else if ($('#id_tab_m').hasClass('active')) printCurrentChartM(dataCurrentM);
                                        }

                                        // T
                                        else {
                                            console.log(" ________________________ T <- R ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printCurrentTableSI(dataCurrentSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printCurrentTableDSI(dataCurrentDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printCurrentTableQF(dataCurrentQF);
                                            else if ($('#id_tab_m').hasClass('active')) printCurrentTableM(dataCurrentM);
                                        }
                                    });

                                    // H
                                    $('#id_historical_menu_item').on('click', function(){
                                        $("#id_radar_menu_item").removeClass('active');
                                        $('#id_historical_menu_item').addClass('active');

                                        // G
                                        if ($('#id_graphical_menu_item').hasClass('active')) {
                                            console.log(" ________________________ G <- H ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printHistoricalChartSI(dataHistoricalSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printHistoricalChartDSI(dataHistoricalDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printHistoricalChartQF(dataHistoricalQF);
                                            else if ($('#id_tab_m').hasClass('active')) printHistoricalChartM(dataHistoricalM);
                                        }

                                        // T
                                        else {
                                            console.log(" ________________________ T <- H ________________________ ");
                                            if ($('#id_tab_si').hasClass('active')) printHistoricalTableSI(dataHistoricalSI);
                                            else if ($('#id_tab_dsi').hasClass('active')) printHistoricalTableDSI(dataHistoricalDSI);
                                            else if ($('#id_tab_qf').hasClass('active')) printHistoricalTableQF(dataHistoricalQF);
                                            else if ($('#id_tab_m').hasClass('active')) printHistoricalTableM(dataHistoricalM);
                                        }
                                    });
                                },
                                args: [
                                    {
                                        key: "dtoCSI",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/StrategicIndicators/CurrentEvaluation.json"
                                            };
                                        }
                                    },
                                    {
                                        key: "dtoCDSI",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/DetailedStrategicIndicators/CurrentEvaluation.json"
                                            };
                                        }
                                    },
                                    {
                                        key: "dtoCQF",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/QualityFactors/CurrentEvaluation.json"
                                            };
                                        }
                                    },
                                    /*{
                                        key: "dtoCM",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/Metrics/CurrentEvaluation.json"
                                            };
                                        }
                                    },*/
                                    {
                                        key: "dtoHM",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/Metrics/HistoricalData/from="+ from +"&to="+ to +".json"
                                            };
                                        }
                                    },
                                    {
                                        key: "dtoHQF",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/QualityFactors/HistoricalData/from="+ from +"&to="+ to +".json"
                                            };
                                        }
                                    },
                                    {
                                        key: "dtoHDSI",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/DetailedStrategicIndicators/HistoricalData/from="+ from +"&to="+ to +".json"
                                            };
                                        }
                                    },
                                    {
                                        key: "dtoHSI",
                                        ajaxOptions: function() {
                                            return {
                                                url: "/rest/qrapids-gadget/1.0/StrategicIndicators/HistoricalData/from="+ from +"&to="+ to +".json"
                                            };
                                        }
                                    }
                                ]
                            }
                        });
                    })();

                </script>
            </head>

            <body>
                <div class="topnav hidden" id="myTopnav">
                    <a id="id_tab_si" class="tab-nav active" data-toggle="tab" href="#si">Strategic Indicators</a>
                    <a id="id_tab_dsi" class="tab-nav" data-toggle="tab" href="#dsi">Detailed Strategic Indicators</a>
                    <a id="id_tab_qf" class="tab-nav" data-toggle="tab" href="#qf">Quality Factors</a>
                    <a id="id_tab_m" class="tab-nav" data-toggle="tab" href="#m">Metrics</a>
                    <span class="span-position">
                        <div class="dropdown">
                            <a href="#" data-toggle="dropdown" class="dropdown-toggle">View mode <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a id="id_graphical_menu_item" class="active">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/graphical.png" alt="graphical data"> Graphical
                                    </a>
                                </li>
                                <li>
                                    <a id="id_table_menu_item">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/table.png" alt="table data"> Table
                                    </a>
                                </li>
                                <li role="separator" class="divider"></li>
                                <li>
                                    <a id="id_radar_menu_item" class="active">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/radar.png" alt="radar data"> Radar
                                    </a>
                                </li>
                                <li>
                                    <a id="id_historical_menu_item">
                                        <img class="icons-view-mode" src="__ATLASSIAN_BASE_URL__/download/resources/com.atlassian.plugins.qrapids.jira-gadget-qrapids-plugin/images/histo.png" alt="histo data"> Historical
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </span>
                </div>

                <div id="myTabContent" class="tab-content clearfix hidden">
                    <div class="tab-pane active" id="si"></div>
                    <div class="tab-pane" id="dsi"></div>
                    <div class="tab-pane" id="qf"></div>
                    <div class="tab-pane" id="m"></div>
                </div>

                <div id="debug_div" style="font-size:9pt; padding:5px; color: red;"></div>

            </body>


        ]]>
    </Content>
</Module>